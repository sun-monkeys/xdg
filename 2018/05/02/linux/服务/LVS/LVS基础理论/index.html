<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.css.network/css?family=Lato:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Consolas:300,300italic,400,400italic,700,700italic|Iosevka:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="LVS," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.png?v=5.1.0" />






<meta name="description" content="系统扩展方式123Scale UP: 向上扩展,增强Scale Out: 向外扩展,增加设备，调度分配问题，ClusterCluster: 集群，为解决某个特定问题将多台计算机组合起来形成的单个系统 Linux Cluster类型12345678910LB: Load Balancing，负载均衡HA: High Availiablity，高可用，SPOF（single Point Of fail">
<meta name="keywords" content="LVS">
<meta property="og:type" content="article">
<meta property="og:title" content="LVS基础理论">
<meta property="og:url" content="http://yoursite.com/2018/05/02/linux/服务/LVS/LVS基础理论/index.html">
<meta property="og:site_name" content="Zookeeper">
<meta property="og:description" content="系统扩展方式123Scale UP: 向上扩展,增强Scale Out: 向外扩展,增加设备，调度分配问题，ClusterCluster: 集群，为解决某个特定问题将多台计算机组合起来形成的单个系统 Linux Cluster类型12345678910LB: Load Balancing，负载均衡HA: High Availiablity，高可用，SPOF（single Point Of fail">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-05-16T08:08:59.717Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="LVS基础理论">
<meta name="twitter:description" content="系统扩展方式123Scale UP: 向上扩展,增强Scale Out: 向外扩展,增加设备，调度分配问题，ClusterCluster: 集群，为解决某个特定问题将多台计算机组合起来形成的单个系统 Linux Cluster类型12345678910LB: Load Balancing，负载均衡HA: High Availiablity，高可用，SPOF（single Point Of fail">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/05/02/linux/服务/LVS/LVS基础理论/"/>





  <title> LVS基础理论 | Zookeeper </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?822bf9a08ff5afbcfcc481a56a6ad577";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Zookeeper</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Still see you as the whole of my life</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home Page
          </a>
        </li>
      
        
        <li class="menu-item menu-item-linux1">
          <a href="/categories/LinuxBasics" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-linux"></i> <br />
            
            Linux Basics
          </a>
        </li>
      
        
        <li class="menu-item menu-item-linux2">
          <a href="/categories/LinuxServices" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-linux"></i> <br />
            
            Linux Services
          </a>
        </li>
      
        
        <li class="menu-item menu-item-python1">
          <a href="/categories/PythonBasics" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-rub"></i> <br />
            
            Python Basics
          </a>
        </li>
      
        
        <li class="menu-item menu-item-python2">
          <a href="/categories/PythonCase" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-rub"></i> <br />
            
            Python Case
          </a>
        </li>
      
        
        <li class="menu-item menu-item-question1">
          <a href="/categories/CommonQuestion" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-bug"></i> <br />
            
            Common Question
          </a>
        </li>
      
        
        <li class="menu-item menu-item-question2">
          <a href="/categories/InterviewQuestion" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-bug"></i> <br />
            
            Interview Question
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/02/linux/服务/LVS/LVS基础理论/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="XDG">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zookeeper">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                LVS基础理论
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-02T00:00:00+08:00">
                2018-05-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="系统扩展方式"><a href="#系统扩展方式" class="headerlink" title="系统扩展方式"></a>系统扩展方式</h1><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Scale</span> UP: 向上扩展,增强</span><br><span class="line"><span class="built_in">Scale</span> <span class="keyword">Out</span>: 向外扩展,增加设备，调度分配问题，Cluster</span><br><span class="line">Cluster: 集群，为解决某个特定问题将多台计算机组合起来形成的单个系统</span><br></pre></td></tr></table></figure>
<h1 id="Linux-Cluster类型"><a href="#Linux-Cluster类型" class="headerlink" title="Linux Cluster类型"></a>Linux Cluster类型</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">LB: <span class="keyword">Load</span> Balancing，负载均衡</span><br><span class="line">HA: <span class="keyword">High</span> Availiablity，高可用，SPOF（single Point <span class="keyword">Of</span> <span class="keyword">failure</span>）</span><br><span class="line">   MTBF: Mean <span class="keyword">Time</span> <span class="keyword">Between</span> <span class="keyword">Failure</span> 平均无故障时间</span><br><span class="line">   MTTR: Mean <span class="keyword">Time</span> <span class="keyword">To</span> Restoration（ <span class="keyword">repair</span>）平均恢复前时间</span><br><span class="line">   A=MTBF/（MTBF+MTTR） (<span class="number">0</span>,<span class="number">1</span>): <span class="number">99</span>%, <span class="number">99.5</span>%, <span class="number">99.9</span>%, <span class="number">99.99</span>%, <span class="number">99.999</span>%, <span class="number">99.9999</span>%</span><br><span class="line">   HPC: <span class="keyword">High</span>-<span class="keyword">performance</span> computing，高性能 www.top500.org</span><br><span class="line"></span><br><span class="line">分布式系统</span><br><span class="line">   分布式存储: 如: 云盘</span><br><span class="line">   分布式计算: 如: hadoop，Spark</span><br></pre></td></tr></table></figure>
<h1 id="LB-Cluster的实现"><a href="#LB-Cluster的实现" class="headerlink" title="LB Cluster的实现"></a>LB Cluster的实现</h1><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">硬件</span><br><span class="line">   F5 Big-IP</span><br><span class="line">   Citrix Netscaler</span><br><span class="line">   A10 A10</span><br><span class="line">软件</span><br><span class="line">   lvs: Linux Virtual<span class="built_in"> Server </span> # 不支持应用层的调度</span><br><span class="line">   nginx: 支持四层调度</span><br><span class="line">   haproxy: 支持四层调度</span><br><span class="line">   ats：apache traffic server: yahoo捐助</span><br><span class="line">   perlbal: Perl 编写</span><br><span class="line">   pound</span><br></pre></td></tr></table></figure>
<h1 id="基于工作的协议层次划分"><a href="#基于工作的协议层次划分" class="headerlink" title="基于工作的协议层次划分"></a>基于工作的协议层次划分</h1><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">传输层（通用）: DPORT</span><br><span class="line">   LVS:</span><br><span class="line">   nginx: stream</span><br><span class="line">   haproxy: mode tcp</span><br><span class="line">应用层（专用）: 针对特定协议，自定义的请求模型分类</span><br><span class="line">  <span class="built_in"> proxy </span>server</span><br><span class="line">      http: nginx, httpd, haproxy(mode http), <span class="built_in">..</span>.</span><br><span class="line">      fastcgi: nginx, httpd, <span class="built_in">..</span>.</span><br><span class="line">      mysql: mysql-proxy, <span class="built_in">..</span>.</span><br></pre></td></tr></table></figure>
<h1 id="会话保持（负载均衡）"><a href="#会话保持（负载均衡）" class="headerlink" title="会话保持（负载均衡）"></a>会话保持（负载均衡）</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">(1)</span> <span class="string">session</span> <span class="attr">sticky:</span> <span class="string">同一用户调度固定服务器</span></span><br><span class="line">   <span class="string">Source</span> <span class="attr">IP:</span> <span class="string">LVS</span> <span class="string">sh算法（对某一特定服务而言）</span></span><br><span class="line">   <span class="string">Cookie</span></span><br><span class="line"></span><br><span class="line"><span class="string">(2)</span> <span class="string">session</span> <span class="attr">replication:</span> <span class="string">每台服务器拥有全部session</span></span><br><span class="line">   <span class="string">session</span> <span class="string">multicast</span> <span class="string">cluster</span></span><br><span class="line"></span><br><span class="line"><span class="string">(3)</span> <span class="string">session</span> <span class="attr">server:</span> <span class="string">专门的session服务器</span></span><br><span class="line">   <span class="string">Memcached，Redis</span></span><br><span class="line"><span class="attr">      cookie:</span> <span class="string">服务器分发给客户端的</span></span><br><span class="line"><span class="attr">      session:</span> <span class="string">识别客户端的信息表</span></span><br></pre></td></tr></table></figure>
<h1 id="HA集群实现方案"><a href="#HA集群实现方案" class="headerlink" title="HA集群实现方案"></a>HA集群实现方案</h1><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">keepalived:</span> vrrp协议</span><br><span class="line"><span class="symbol">ais:</span> 应用接口规范</span><br><span class="line">   heartbeat</span><br><span class="line">   cman+rgmanager(RHCS)</span><br><span class="line">   coresync_pacemaker</span><br></pre></td></tr></table></figure>
<h1 id="LVS概念"><a href="#LVS概念" class="headerlink" title="LVS概念"></a>LVS概念</h1><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">LVS:</span> Linux Virtual Server，负载调度器，集成内核   章文嵩  阿里</span><br><span class="line">   官网: http:<span class="comment">//www.linuxvirtualserver.org/</span></span><br><span class="line"><span class="symbol">   VS:</span> Virtual Server，负责调度</span><br><span class="line"><span class="symbol">   RS:</span> Real Server，负责真正提供服务</span><br><span class="line"><span class="symbol">   L4:</span> 四层路由器或交换机</span><br><span class="line"></span><br><span class="line">工作原理: VS根据请求报文目标IP和目标协议及端口将调度转发至某RS，根据调度算法来挑选RS</span><br><span class="line"><span class="meta"># 工作的位置: PREROUTEING --- 路由选择 --- LVS的调度 --- INPUT （这里只考虑位置）</span></span><br><span class="line"></span><br><span class="line">iptables/netfilter</span><br><span class="line"><span class="symbol">   iptables:</span> 用户空间的管理工具</span><br><span class="line"><span class="symbol">   netfilter:</span> 内核空间上的框架</span><br><span class="line">   流入: PREROUTING --&gt; INPUT</span><br><span class="line">   流出: OUTPUT --&gt; POSTROUTING</span><br><span class="line">   转发: PREROUTING --&gt; FORWARD --&gt; POSTROUTING</span><br><span class="line"><span class="symbol">   DNAT:</span> 目标地址转换； PREROUTING</span><br><span class="line"></span><br><span class="line">lvs集群类型中的术语</span><br><span class="line"><span class="symbol">   VS:</span> Virtual Server, Director, Dispatcher(调度器) Load Balancer</span><br><span class="line"><span class="symbol">   RS:</span> Real Server(lvs), upstream server(nginx) backend server(haproxy)</span><br><span class="line"><span class="symbol">   CIP:</span> Client IP</span><br><span class="line"><span class="symbol">   VIP:</span> Virtual serve IP   VS外网的IP</span><br><span class="line"><span class="symbol">   DIP:</span> Director IP        VS内网的IP</span><br><span class="line"><span class="symbol">   RIP:</span> Real server IP</span><br><span class="line">访问流程: CIP <span class="params">&lt;--&gt;</span> VIP == DIP <span class="params">&lt;--&gt;</span> RIP</span><br></pre></td></tr></table></figure>
<h1 id="lvs集群的类型"><a href="#lvs集群的类型" class="headerlink" title="lvs集群的类型"></a>lvs集群的类型</h1><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">lvs</span>: ipvsadm/ipvs</span><br><span class="line">   ipvsadm</span><br><span class="line">      用户空间的命令行工具，规则管理器</span><br><span class="line">      用于管理集群服务及RealServer</span><br><span class="line">   ipvs</span><br><span class="line">      工作于内核空间netfilter的INPUT钩子上的框架</span><br><span class="line"></span><br><span class="line"><span class="symbol">lvs</span>集群的类型</span><br><span class="line">   lvs-nat: 修改请求报文的目标<span class="built_in">IP</span>，多目标<span class="built_in">IP</span>的DNAT</span><br><span class="line">   lvs-dr: 操纵封装新的MAC地址</span><br><span class="line">   lvs-tun: 在原请求<span class="built_in">IP</span>报文之外新加一个<span class="built_in">IP</span>首部</span><br><span class="line">   lvs-fullnat: 修改请求报文的源和目标<span class="built_in">IP</span></span><br></pre></td></tr></table></figure>
<h2 id="lvs-nat模式"><a href="#lvs-nat模式" class="headerlink" title="lvs-nat模式"></a>lvs-nat模式</h2><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">本质是多目标<span class="built_in">IP</span>的DNAT，通过将请求报文中的目标地址和目标端口修改为</span><br><span class="line">  某挑出的RS的<span class="built_in">RIP</span>和PORT实现转发</span><br><span class="line">（<span class="number">1</span>）<span class="built_in">RIP</span>和DIP建议在同一个<span class="built_in">IP</span>网络，且应该使用私网地址，RS的网关要指向DIP</span><br><span class="line">   # nat工作模式当中<span class="built_in">RIP</span>和DIP之间，可以跨网络</span><br><span class="line">（<span class="number">2</span>）请求报文和响应报文都必须经由Director转发，Director易于成为系统瓶颈</span><br><span class="line">（<span class="number">3</span>）支持端口映射，可修改请求报文的目标PORT</span><br><span class="line">（<span class="number">4</span>）VS必须是Linux系统，RS可以是任意OS系统</span><br></pre></td></tr></table></figure>
<h2 id="lvs-dr模式"><a href="#lvs-dr模式" class="headerlink" title="lvs-dr模式"></a>lvs-dr模式</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">LVS-DR: Direct Routing，直接路由，LVS默认模式,应用最广泛，通过为请求报文重新封装</span><br><span class="line">  一个MAC首部进行转发，源MAC是DIP 所在的接口的MAC，目标MAC是某挑选出的RS的RIP所在</span><br><span class="line">  接口的MAC地址，源IP/PORT，以及目标IP/PORT均保持不变</span><br><span class="line"></span><br><span class="line">Director和各RS都配置有VIP</span><br><span class="line">   (1)确保前端路由器将目标IP为VIP的请求报文发往Director</span><br><span class="line">      在前端网关做静态绑定VIP和Director的MAC地址  # 做MAC地址绑定</span><br><span class="line">      在RS上使用arptables工具  # 静态VIP的绑定</span><br><span class="line">      arptables -A <span class="keyword">IN</span> -d <span class="variable">$VIP</span> -j DROP</span><br><span class="line">      arptables -A OUT -s <span class="variable">$VIP</span> -j<span class="built_in"> mangle </span>--mangle-ip-s <span class="variable">$RIP</span></span><br><span class="line">      在RS上修改内核参数以限制arp通告及应答级别</span><br><span class="line">         arp_announce</span><br><span class="line">         arp_ignore</span><br><span class="line"><span class="comment"># 如果一个网络中配置多个ip地址的冲突原理</span></span><br><span class="line"><span class="comment">#   获取地址的时候，会向网络中广播这个地址是否有人在使用（然后自问自答，没有情况下）</span></span><br><span class="line"><span class="comment">#   如果有人使用的话，使用的人会说，这个地址我在使用中，返回应答信息</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自己配置的地址和别人相同的话，在别人广播询问时，本机不做回答，这样就不冲突了</span></span><br><span class="line"><span class="comment">#   arp_announce  # 不对外宣称自己的地址</span></span><br><span class="line"><span class="comment">#   arp_ignore    # 不响应</span></span><br><span class="line"><span class="comment">#   就是修改这两个arp参数</span></span><br><span class="line"></span><br><span class="line">   (2)RS的RIP可以使用私网地址，也可以是公网地址；RIP与 DIP在同一IP网络，</span><br><span class="line">     RIP的网关不能指向DIP，以确保响应报文 不会经由Director</span><br><span class="line">   (3)RS和Director要在同一个物理网络</span><br><span class="line">   (4)请求报文要经由Director，但响应报文不经由Director，而由RS直接发往Client</span><br><span class="line">   (5)不支持端口映射（端口不能修改）</span><br><span class="line">   (6)RS可使用大多数OS系统</span><br></pre></td></tr></table></figure>
<h2 id="lvs-tun模式"><a href="#lvs-tun模式" class="headerlink" title="lvs-tun模式"></a>lvs-tun模式</h2><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">转发方式: 不修改请求报文的<span class="built_in">IP</span>首部（源<span class="built_in">IP</span>为CIP，目标<span class="built_in">IP</span>为VIP），而在原<span class="built_in">IP</span>报文之外再封装一个</span><br><span class="line">  <span class="built_in">IP</span>首部（源<span class="built_in">IP</span>是DIP，目标<span class="built_in">IP</span>是<span class="built_in">RIP</span>），将报文发往挑选出的目标RS，</span><br><span class="line">  RS直接响应给客户端（源<span class="built_in">IP</span>是VIP，目标<span class="built_in">IP</span>是CIP）</span><br><span class="line"></span><br><span class="line">(<span class="number">1</span>) DIP, VIP, <span class="built_in">RIP</span>都应该是公网地址</span><br><span class="line">(<span class="number">2</span>) RS的网关不能，也不可能指向DIP</span><br><span class="line">(<span class="number">3</span>) 请求报文要经由Director，但响应不能经由Director</span><br><span class="line">(<span class="number">4</span>) 不支持端口映射</span><br><span class="line">(<span class="number">5</span>) RS的OS须支持隧道功能</span><br></pre></td></tr></table></figure>
<h2 id="lvs-fullnat模式"><a href="#lvs-fullnat模式" class="headerlink" title="lvs-fullnat模式"></a>lvs-fullnat模式</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">通过同时修改请求报文的源IP地址和目标IP地址进行转发 CIP --&gt; DIP   VIP --&gt; RIP</span><br><span class="line">  回来的时候，RIP --&gt; DIP   VIP --&gt; CIP</span><br><span class="line"></span><br><span class="line">(1)VIP是公网地址，RIP和DIP是私网地址，通常不在同一IP网络，因此RIP的网关一般不会指向DIP</span><br><span class="line">(2)RS收到的请求报文源地址是DIP，因此只需响应给DIP，但Director还要将其发往Client</span><br><span class="line">(3)请求和响应报文都经由Director</span><br><span class="line">(4)支持端口映射</span><br><span class="line"><span class="comment"># 此类型kernel默认不支持</span></span><br></pre></td></tr></table></figure>
<h2 id="模式之间的区别"><a href="#模式之间的区别" class="headerlink" title="模式之间的区别"></a>模式之间的区别</h2><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">lvs-nat与lvs-fullnat</span><br><span class="line">   请求和响应报文都经由Director</span><br><span class="line">   lvs-nat</span><br><span class="line">      <span class="built_in">RIP</span>的网关要指向DIP</span><br><span class="line">   lvs-fullnat</span><br><span class="line">      <span class="built_in">RIP</span>和DIP未必在同一<span class="built_in">IP</span>网络，但要能通信</span><br><span class="line"></span><br><span class="line">lvs-dr与lvs-tun</span><br><span class="line">   请求报文要经由Director，但响应报文由RS直接发往Client</span><br><span class="line">   lvs-dr</span><br><span class="line">      通过封装新的MAC首部实现，通过MAC网络转发</span><br><span class="line">   lvs-tun</span><br><span class="line">      通过在原<span class="built_in">IP</span>报文外封装新<span class="built_in">IP</span>头实现转发，支持远距离通信</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="ipvs-scheduler"><a href="#ipvs-scheduler" class="headerlink" title="ipvs scheduler"></a>ipvs scheduler</h1><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">根据其调度时是否考虑各RS当前的负载状态</span><br><span class="line">   两种: 静态方法和动态方法</span><br><span class="line"></span><br><span class="line">静态方法: 仅根据算法本身进行调度</span><br><span class="line">   <span class="number">1</span>、RR: roundrobin  <span class="comment"># 轮询</span></span><br><span class="line">   <span class="number">2</span>、WRR: Weighted RR  <span class="comment"># 加权轮询</span></span><br><span class="line">   <span class="number">3</span>、<span class="keyword">SH: </span>Source Hashing  <span class="comment"># 实现session sticky，源IP地址hash</span></span><br><span class="line">   <span class="comment"># 将来自于同一个IP地址的请求始终发往第一次挑中的RS，从而实现会话绑定</span></span><br><span class="line">   <span class="number">4</span>、DH: Destination Hashing  <span class="comment"># 目标地址哈希</span></span><br><span class="line">   <span class="comment"># 将发往同一个目标地址的请求始终转发至第一次挑中的RS，典型使用场景是正向代理缓存</span></span><br><span class="line">   <span class="comment">#   场景中的负载均衡</span></span><br><span class="line">   <span class="comment"># 如: 宽带运营商（缓存服务器如果访问量过大，还需要使用同步到其它的服务器来负载分布）</span></span><br><span class="line"></span><br><span class="line">动态方法: 主要根据每RS当前的负载状态及调度算法进行调度</span><br><span class="line"><span class="comment"># 注: Overhead=value（较小的RS将被调度）</span></span><br><span class="line">   <span class="number">1</span>、LC: least connections  <span class="comment"># 适用于长连接应用</span></span><br><span class="line">   <span class="comment"># Overhead=activeconns*256+inactiveconns</span></span><br><span class="line">   <span class="number">2</span>、WLC: Weighted LC  <span class="comment"># 默认调度方法</span></span><br><span class="line">   <span class="comment"># Overhead=(activeconns*256+inactiveconns)/weight</span></span><br><span class="line">   <span class="number">3</span>、SED: <span class="keyword">Shortest </span>Expection Delay  <span class="comment"># 初始连接高权重优先</span></span><br><span class="line">   <span class="comment"># Overhead=(activeconns+1)*256/weight</span></span><br><span class="line">   <span class="number">4</span>、NQ: Never Queue  <span class="comment"># 第一轮均匀分配，后续SED</span></span><br><span class="line">   <span class="comment"># 如果第一个权重比较大，一开始始终都分配给权重大的，后面服务器无法接收任务</span></span><br><span class="line">   <span class="comment"># 一开始先平均的分一个，然后再算</span></span><br><span class="line">   <span class="number">5</span>、<span class="keyword">LBLC: </span>Locality-<span class="keyword">Based </span>LC  <span class="comment"># 动态的DH算法，使用场景: 根据负载状态实现正向代理</span></span><br><span class="line">   <span class="comment"># 跟DH相比，实现了负载的实际情况来</span></span><br><span class="line">   <span class="number">6</span>、<span class="keyword">LBLCR: </span><span class="keyword">LBLC </span>with Replication</span><br><span class="line">   <span class="comment"># 带复制功能的LBLC，解决LBLC负载不均衡问题，从负载重的复制到负载轻的RS</span></span><br></pre></td></tr></table></figure>
<h1 id="ipvsadm-ipvs"><a href="#ipvsadm-ipvs" class="headerlink" title="ipvsadm/ipvs"></a>ipvsadm/ipvs</h1><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">grep -i -C 10 <span class="string">"ipvs"</span> /boot/config-VERSIONRELEASE.x86_64</span><br><span class="line"><span class="comment"># -C是查看前后10行的内容</span></span><br><span class="line">   # IPVS scheduler</span><br><span class="line">   <span class="attribute">CONFIG_IP_VS_RR</span>=m</span><br><span class="line">   <span class="attribute">CONFIG_IP_VS_WRR</span>=m</span><br><span class="line">   <span class="attribute">CONFIG_IP_VS_LC</span>=m</span><br><span class="line">   <span class="attribute">CONFIG_IP_VS_WLC</span>=m</span><br><span class="line">   <span class="attribute">CONFIG_IP_VS_LBLC</span>=m</span><br><span class="line">   <span class="attribute">CONFIG_IP_VS_LBLCR</span>=m</span><br><span class="line">   <span class="attribute">CONFIG_IP_VS_DH</span>=m</span><br><span class="line">   <span class="attribute">CONFIG_IP_VS_SH</span>=m</span><br><span class="line">   <span class="attribute">CONFIG_IP_VS_SED</span>=m</span><br><span class="line">   <span class="attribute">CONFIG_IP_VS_NQ</span>=m</span><br><span class="line">支持的协议: TCP，UDP，AH，ESP，AH_ESP，SCTP</span><br><span class="line"></span><br><span class="line">ipvs集群</span><br><span class="line">   管理集群服务</span><br><span class="line">   管理服务上的RS</span><br></pre></td></tr></table></figure>
<h2 id="ipvsadm包构成"><a href="#ipvsadm包构成" class="headerlink" title="ipvsadm包构成"></a>ipvsadm包构成</h2><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">程序包: ipvsadm</span><br><span class="line">   Unit <span class="symbol">File:</span> ipvsadm.service</span><br><span class="line">   主程序: <span class="regexp">/usr/sbin</span><span class="regexp">/ipvsadm</span></span><br><span class="line"><span class="regexp">   规则保存工具: /usr</span><span class="regexp">/sbin/ipvsadm</span>-save</span><br><span class="line">   规则重载工具: <span class="regexp">/usr/sbin</span><span class="regexp">/ipvsadm-restore</span></span><br><span class="line"><span class="regexp">   配置文件: /etc</span><span class="regexp">/sysconfig/ipvsadm</span>-config</span><br></pre></td></tr></table></figure>
<h2 id="ipvsadm命令"><a href="#ipvsadm命令" class="headerlink" title="ipvsadm命令"></a>ipvsadm命令</h2><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">集群服务管理: 增、删、改</span><br><span class="line">集群服务的RS管理: 增、删、改</span><br><span class="line">查看</span><br><span class="line">   ipvsadm -A|<span class="type">E</span> -t|<span class="type">u</span>|<span class="type">f</span> service-address [-s scheduler] [-p [<span class="built_in">timeout</span>]] </span><br><span class="line">     [-M netmask] [--pe persistence_engine] [-b sched-flags]</span><br><span class="line">   ipvsadm -D -t|<span class="type">u</span>|<span class="type">f</span> service-address  删除</span><br><span class="line">   ipvsadm –C  清空</span><br><span class="line">   # 一般在修改的时候，会出现错误，这是软件的BUG，最好删除之后，再从新添加进去</span><br><span class="line">   ipvsadm –R  重载</span><br><span class="line">   ipvsadm -S [-n]  保存</span><br><span class="line">   ipvsadm -a|<span class="type">e</span> -t|<span class="type">u</span>|<span class="type">f</span> service-address -r server-address [options]</span><br><span class="line">   ipvsadm -d -t|<span class="type">u</span>|<span class="type">f</span> service-address -r server-address</span><br><span class="line">   ipvsadm -L|<span class="type">l</span> [options]</span><br><span class="line">   ipvsadm -Z [-t|<span class="type">u</span>|<span class="type">f</span> service-address]</span><br><span class="line"></span><br><span class="line">管理集群服务: 增、改、删</span><br><span class="line">   增、改</span><br><span class="line">      ipvsadm -A|<span class="type">E</span> -t|<span class="type">u</span>|<span class="type">f</span> service-address [-s scheduler] [-p [<span class="built_in">timeout</span>]]</span><br><span class="line">   删除</span><br><span class="line">      ipvsadm -D -t|<span class="type">u</span>|<span class="type">f</span> service-address</span><br><span class="line">   service-address（指的是公网上的VS的地址）</span><br><span class="line">      -t|<span class="type">u</span>|<span class="type">f</span>:</span><br><span class="line">         -t: TCP协议的端口，VIP:TCP_PORT</span><br><span class="line">         -u: UDP协议的端口，VIP:UDP_PORT</span><br><span class="line">         -f: firewall MARK，标记，一个数字</span><br><span class="line">   [-s scheduler]: 指定集群的调度算法，默认为wlc  # 静态和动态算法</span><br><span class="line"></span><br><span class="line">管理集群上的RS: 增、改、删</span><br><span class="line">   增、改</span><br><span class="line">      ipvsadm -a|<span class="type">e</span> -t|<span class="type">u</span>|<span class="type">f</span> service-address -r server-address [-g|<span class="type">i</span>|<span class="type">m</span>] [-w weight]</span><br><span class="line">   删除</span><br><span class="line">      ipvsadm -d -t|<span class="type">u</span>|<span class="type">f</span> service-address -r serveraddress</span><br><span class="line">         server-address</span><br><span class="line">            -t: 指的是vs的公网的地址加端口  格式: vip:port（必须是这个格式）</span><br><span class="line">            -r: 指的是rs的ip地址，端口指的服务</span><br><span class="line">            rip[:port]: 如省略port，不作端口映射</span><br><span class="line">选项</span><br><span class="line">   lvs类型</span><br><span class="line">      -g: gateway，dr类型，默认</span><br><span class="line">      -i: ipip，tun类型</span><br><span class="line">      -m: masquerade，nat类型</span><br><span class="line">      -w weight: 权重</span><br><span class="line"></span><br><span class="line">清空定义的所有内容: ipvsadm –C</span><br><span class="line">清空计数器: ipvsadm -Z [-t|<span class="type">u</span>|<span class="type">f</span> service-address]</span><br><span class="line">查看: ipvsadm -L|<span class="type">l</span> [options]</span><br><span class="line">   --numeric, -n: 以数字形式输出地址和端口号</span><br><span class="line">   --<span class="built_in">exact</span>: 扩展信息，精确值</span><br><span class="line">   --connection，-c: 当前IPVS连接输出</span><br><span class="line">   --stats: 统计信息</span><br><span class="line">   --rate: 输出速率信息</span><br><span class="line"></span><br><span class="line">ipvs规则: /proc/net/ip_vs</span><br><span class="line">ipvs连接: /proc/net/ip_vs_conn</span><br></pre></td></tr></table></figure>
<h2 id="保存及重载规则"><a href="#保存及重载规则" class="headerlink" title="保存及重载规则"></a>保存及重载规则</h2><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">保存: 建议保存至<span class="string">/etc/sysconfig/ipvsadm</span></span><br><span class="line">   ipvsadm-save &gt; <span class="string">/PATH/TO/IPVSADM_FILE</span></span><br><span class="line">   ipvsadm -S &gt; <span class="string">/PATH/TO/IPVSADM_FILE</span></span><br><span class="line">   systemctl stop ipvsadm.service</span><br><span class="line"><span class="comment"># 关闭开启只是重新加载一下配置文件（如果配置文件被删除是启动不了的）</span></span><br><span class="line"></span><br><span class="line">重载</span><br><span class="line">   ipvsadm-restore &lt; <span class="string">/PATH/FROM/IPVSADM_FILE</span></span><br><span class="line">   ipvsadm -R &lt; <span class="string">/PATH/FROM/IPVSADM_FILE</span></span><br><span class="line">   systemctl restart ipvsadm.service</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="LVS相关说明"><a href="#LVS相关说明" class="headerlink" title="LVS相关说明"></a>LVS相关说明</h1><h2 id="负载均衡集群设计时要注意的问题"><a href="#负载均衡集群设计时要注意的问题" class="headerlink" title="负载均衡集群设计时要注意的问题"></a>负载均衡集群设计时要注意的问题</h2><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>) 是否需要会话保持</span><br><span class="line">(<span class="number">2</span>) 是否需要共享存储</span><br><span class="line">   共享存储: NAS，SAN，DS（分布式存储）</span><br><span class="line">   数据同步:</span><br><span class="line"></span><br><span class="line">lvs-nat</span><br><span class="line">   (<span class="number">1</span>)RIP与DIP在同一IP网络, RIP的网关要指向DIP</span><br><span class="line">   (<span class="number">2</span>)支持端口映射</span><br><span class="line">   (<span class="number">3</span>)Director要打开核心转发功能</span><br><span class="line">	</span><br><span class="line">LVS-DR</span><br><span class="line">dr模型中，各主机上均需要配置VIP，解决地址冲突的方式有三种:</span><br><span class="line">   (<span class="number">1</span>)在前端网关做静态绑定</span><br><span class="line">   (<span class="number">2</span>)在各RS使用arptables</span><br><span class="line">   (<span class="number">3</span>)在各RS修改内核参数，来限制arp响应和通告的级别</span><br><span class="line"></span><br><span class="line">   限制响应级别: arp_ignore</span><br><span class="line">      <span class="number">0</span>: 默认值，表示可使用本地任意接口上配置的任意地址进行响应</span><br><span class="line">      <span class="number">1</span>: 仅在请求的目标IP配置在本地主机的接收到请求报文的接口上时，才给予响应</span><br><span class="line">      <span class="meta"># 比如一个主机上有多个网卡（网卡1，网卡2,...）</span></span><br><span class="line">      <span class="meta"># 网卡1: 172.18.0.0，尽量只接收网卡1的地址广播，才给予响应</span></span><br><span class="line"></span><br><span class="line">   限制通告级别: arp_announce</span><br><span class="line">      <span class="number">0</span>: 默认值，把本机所有接口的所有信息向每个接口的网络进行通告</span><br><span class="line">      <span class="number">1</span>: 尽量避免将接口信息向非直接连接网络进行通告</span><br><span class="line">      <span class="number">2</span>: 必须避免将接口信息向非本网络进行通告</span><br><span class="line">   <span class="meta"># 查看脚本 lvs_dr_vs   lvs_dr_rs</span></span><br><span class="line"></span><br><span class="line">   echo <span class="number">1</span> &gt; <span class="meta-keyword">/proc/</span>sys<span class="meta-keyword">/net/</span>ipv4<span class="meta-keyword">/conf/</span>all/arp_ignore</span><br><span class="line">   echo <span class="number">1</span> &gt; <span class="meta-keyword">/proc/</span>sys<span class="meta-keyword">/net/</span>ipv4<span class="meta-keyword">/conf/</span>lo/arp_ignore</span><br><span class="line">   echo <span class="number">2</span> &gt; <span class="meta-keyword">/proc/</span>sys<span class="meta-keyword">/net/</span>ipv4<span class="meta-keyword">/conf/</span>all/arp_announce</span><br><span class="line">   echo <span class="number">2</span> &gt; <span class="meta-keyword">/proc/</span>sys<span class="meta-keyword">/net/</span>ipv4<span class="meta-keyword">/conf/</span>lo/arp_announce</span><br></pre></td></tr></table></figure>
<h2 id="FireWall-Mark"><a href="#FireWall-Mark" class="headerlink" title="FireWall Mark"></a>FireWall Mark</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">FWM：FireWall Mark</span><br><span class="line">   MARK target: 可用于给特定的报文打标记</span><br><span class="line">      --set-mark value  # value 为十六进制数字</span><br><span class="line">      # 借助于防火墙标记来分类报文，而后基于标记定义集群服务，可将多个不同的应用</span><br><span class="line">      #   使用同一个集群服务进行调度</span><br><span class="line"></span><br><span class="line">实现方法:</span><br><span class="line">   在Director主机打标记</span><br><span class="line">      iptables -t<span class="built_in"> mangle </span>-A PREROUTING -d <span class="variable">$vip</span> -p <span class="variable">$proto</span> –m multiport </span><br><span class="line">        --dports <span class="variable">$port1</span>,<span class="variable">$port2</span>,<span class="built_in">..</span>.  -j MARK --set-mark NUMBER</span><br><span class="line">   在Director主机基于标记定义集群服务</span><br><span class="line">      ipvsadm -A -f NUMBER [options]</span><br></pre></td></tr></table></figure>
<h2 id="持久连接"><a href="#持久连接" class="headerlink" title="持久连接"></a>持久连接</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">session绑定</span>: 对共享同一组RS的多个集群服务，需要统一进行绑定lvs sh算法无法实现</span><br><span class="line"></span><br><span class="line">持久连接（lvs persistence）模板: 实现无论使用任何调度算法，在一段时间内（默认360s），</span><br><span class="line">  能够实现将来自同一个地址的请求始终发往同一个RS</span><br><span class="line">   ipvsadm -A|E -t|u|f service-address [-s scheduler] [-p [timeout]]</span><br><span class="line"></span><br><span class="line">持久连接实现方式</span><br><span class="line">   每端口持久(PPC): 每个端口对应定义为一个集群服务，每集群服务单独调度</span><br><span class="line">   每防火墙标记持久(PFWMC): 基于防火墙标记定义集群服务，可实现将多个端口上的</span><br><span class="line">     应用统一调度，即所谓的port Affinity</span><br><span class="line">   每客户端持久(PCC): 基于0端口（表示所有服务）定义集群服务，即将客户端对</span><br><span class="line">     所有应用的请求都调度至后端主机，必须定义为持久模式</span><br></pre></td></tr></table></figure>
<h2 id="LVS高可用性"><a href="#LVS高可用性" class="headerlink" title="LVS高可用性"></a>LVS高可用性</h2><figure class="highlight ruleslanguage"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>)Director不可用，整个系统将不可用，SPoF Single Point of Failure</span><br><span class="line">  解决方案: 高可用 keepalived heartbeat/corosync</span><br><span class="line"></span><br><span class="line">(<span class="number">2</span>)某<span class="keyword">RS</span>不可用时，Director依然会调度请求至此<span class="keyword">RS</span></span><br><span class="line">   解决方案: 由Director对各<span class="keyword">RS</span>健康状态进行检查，失败时禁用，成功时启用</span><br><span class="line">      keepalived heartbeat/corosync, ldirectord</span><br><span class="line">   检测方式:</span><br><span class="line">      (a)网络层检测，icmp</span><br><span class="line">      (b)传输层检测，端口探测</span><br><span class="line">      (c)应用层检测，请求某关键资源</span><br><span class="line">   <span class="keyword">RS</span>全不用时: back server, sorry server</span><br></pre></td></tr></table></figure>
<h2 id="ldirectord"><a href="#ldirectord" class="headerlink" title="ldirectord"></a>ldirectord</h2><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">ldirectord: 监控和控制LVS守护进程，可管理LVS规则</span><br><span class="line">包名: ldirectord-<span class="number">3.9</span>.<span class="number">6</span>-<span class="number">0</span>rc1.<span class="number">1.1</span>.x86_64.rpm</span><br><span class="line">文件:</span><br><span class="line">   /etc/ha.d/ldirectord.cf  <span class="comment"># 主配置文件</span></span><br><span class="line">   /usr/share/doc/ldirectord-<span class="number">3.9</span>.<span class="number">6</span>/ldirectord.cf  <span class="comment"># 配置模版</span></span><br><span class="line">   /usr/lib/systemd/system/ldirectord.service  <span class="comment"># 服务</span></span><br><span class="line">   /usr/sbin/ldirectord  <span class="comment"># 主程序</span></span><br><span class="line">   /var/log/ldirectord.log  <span class="comment"># 日志</span></span><br><span class="line">   /var/run/ldirectord.ldirectord.pid  <span class="comment"># pid文件</span></span><br><span class="line"></span><br><span class="line">Ldirectord配置文件示例</span><br><span class="line">   <span class="attr">checktimeout=3</span>  <span class="comment"># 超时时间</span></span><br><span class="line">   <span class="attr">checkinterval=1</span>  <span class="comment"># 1s检查一次，检查间隔</span></span><br><span class="line">   <span class="attr">autoreload=yes</span>  <span class="comment"># 自动加载，不需要重启服务</span></span><br><span class="line">   <span class="attr">logfile="/var/log/ldirectord.log"</span>  <span class="comment"># 日志文件</span></span><br><span class="line">   <span class="attr">quiescent=no</span>  <span class="comment"># down时yes权重为0，no为删除</span></span><br><span class="line">   <span class="attr">virtual=172.18.48.222:80</span>  <span class="comment"># 指定VS的FWM或IP:port</span></span><br><span class="line">      <span class="attr">real=172.16.0.7:80</span> gate <span class="number">2</span>  <span class="comment"># RS服务器</span></span><br><span class="line">      <span class="attr">real=172.16.0.8:80</span> gate <span class="number">1</span></span><br><span class="line">      <span class="attr">fallback=127.0.0.1:80</span> gate</span><br><span class="line">		<span class="comment"># sorry server如果调度服务失败，会跳转到一个自己指定的一个错误界面</span></span><br><span class="line">      <span class="attr">service=http</span>  <span class="comment"># 服务</span></span><br><span class="line">      <span class="attr">scheduler=wrr</span>  <span class="comment"># 算法</span></span><br><span class="line">   <span class="attr">checktype=negotiate</span></span><br><span class="line">   <span class="attr">checkport=80</span>  <span class="comment"># 检测端口</span></span><br><span class="line">   <span class="attr">request="index.html"</span>  <span class="comment"># RS服务器上的哪个页面，进行测试</span></span><br><span class="line">   <span class="attr">receive="Test</span> Ldirectord<span class="string">"  # 如果判断页面是否正常访问呢</span></span><br><span class="line"><span class="string">      # 判断访问的页面当中是否带有Test Ldirectord字符串</span></span><br></pre></td></tr></table></figure>
      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/LVS/" rel="tag"># LVS</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/05/02/linux/服务/LVS/LVS脚本/" rel="next" title="LVS脚本">
                <i class="fa fa-chevron-left"></i> LVS脚本
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/05/02/linux/服务/LVS/LVS实验/" rel="prev" title="LVS实验">
                LVS实验 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="XDG" />
          <p class="site-author-name" itemprop="name">XDG</p>
           
              <p class="site-description motion-element" itemprop="description">Personal Blog</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">97</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">93</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/sun-monkeys/xdg/" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/xddggg" target="_blank" title="weibo">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  weibo
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#系统扩展方式"><span class="nav-number">1.</span> <span class="nav-text">系统扩展方式</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Linux-Cluster类型"><span class="nav-number">2.</span> <span class="nav-text">Linux Cluster类型</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#LB-Cluster的实现"><span class="nav-number">3.</span> <span class="nav-text">LB Cluster的实现</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#基于工作的协议层次划分"><span class="nav-number">4.</span> <span class="nav-text">基于工作的协议层次划分</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#会话保持（负载均衡）"><span class="nav-number">5.</span> <span class="nav-text">会话保持（负载均衡）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#HA集群实现方案"><span class="nav-number">6.</span> <span class="nav-text">HA集群实现方案</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#LVS概念"><span class="nav-number">7.</span> <span class="nav-text">LVS概念</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#lvs集群的类型"><span class="nav-number">8.</span> <span class="nav-text">lvs集群的类型</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#lvs-nat模式"><span class="nav-number">8.1.</span> <span class="nav-text">lvs-nat模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#lvs-dr模式"><span class="nav-number">8.2.</span> <span class="nav-text">lvs-dr模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#lvs-tun模式"><span class="nav-number">8.3.</span> <span class="nav-text">lvs-tun模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#lvs-fullnat模式"><span class="nav-number">8.4.</span> <span class="nav-text">lvs-fullnat模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模式之间的区别"><span class="nav-number">8.5.</span> <span class="nav-text">模式之间的区别</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ipvs-scheduler"><span class="nav-number">9.</span> <span class="nav-text">ipvs scheduler</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ipvsadm-ipvs"><span class="nav-number">10.</span> <span class="nav-text">ipvsadm/ipvs</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ipvsadm包构成"><span class="nav-number">10.1.</span> <span class="nav-text">ipvsadm包构成</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ipvsadm命令"><span class="nav-number">10.2.</span> <span class="nav-text">ipvsadm命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#保存及重载规则"><span class="nav-number">10.3.</span> <span class="nav-text">保存及重载规则</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#LVS相关说明"><span class="nav-number">11.</span> <span class="nav-text">LVS相关说明</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#负载均衡集群设计时要注意的问题"><span class="nav-number">11.1.</span> <span class="nav-text">负载均衡集群设计时要注意的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FireWall-Mark"><span class="nav-number">11.2.</span> <span class="nav-text">FireWall Mark</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#持久连接"><span class="nav-number">11.3.</span> <span class="nav-text">持久连接</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LVS高可用性"><span class="nav-number">11.4.</span> <span class="nav-text">LVS高可用性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ldirectord"><span class="nav-number">11.5.</span> <span class="nav-text">ldirectord</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">XDG</span>
</div>


<div class="powered-by">
   心有猛虎
</div>

<div class="theme-info">
  细嗅蔷薇
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  





  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  





  

  

  

  

</body>
</html>
